{% extends 'lsp/lsp_base.html' %}
{% load static %}
{% block body %}
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
  integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script>
  $(document).ready(function () {

    setInterval(function () {
      $.ajax({
        type: 'GET',
        url: "lsp/getmessages/{{friend}}",
        success: function (response) {
          console.log(response);
          $("#display").empty();
          for (var key in response.messages) {
            if (response.messages[key].sender == '{{request.user}}') {
              if (response.messages[key].file_status) {
                var temp = "<div class='container1 greener'><b>" + response.messages[key].sender + "</b><p><a href=\"" + response.messages[key].message + "\" download>" + response.messages[key].file_name + "</a></p><span class='time-left'>" + response.messages[key].date + "</span></div>";
                $("#display").append(temp);
              }
              else {
                var temp = "<div class='container1 greener'><b>" + response.messages[key].sender + "</b><p>" + response.messages[key].message + "</p><span class='time-left'>" + response.messages[key].date + "</span></div>";
                $("#display").append(temp);
              }
            }
            else {
              if (response.messages[key].file_status) {
                var temp = "<div class='container1 darker'><b>" + response.messages[key].sender + "</b><p><a href=\"" + response.messages[key].message + "\" download>" + response.messages[key].file_name + "</a></p><span class='time-left'>" + response.messages[key].date + "</span></div>";
                $("#display").append(temp);
              }
              else {
                var temp = "<div class='container1 darker'><b>" + response.messages[key].sender + "</b><p>" + response.messages[key].message + "</p><span class='time-left'>" + response.messages[key].date + "</span></div>";
                $("#display").append(temp);
              }
            }
          }
        },
        /*error: function (response) {
          alert('An error occured')
        }*/
      });
    }, 1000);
  })
</script>
<main id="main" class="main">
  <section class="section faq">
    <div class="row">
      <div class="col-lg-12">

        <div class="card basic">
          <div class="card-body">
            <h5 class="card-title">{{friend}}</h5>


            <form id="post-form" autocomplete="off">
              {% csrf_token %}
              <input type="hidden" name="username" id="username" value="{{request.user}}" />
              <input type="hidden" name="friend" id="friend" value="{{friend}}" />

              <div class="row">
                <div class="col-lg-10">
                  <input class="form-control" type="text" name="message" id="message" autocomplete="off" />
                </div>
                <div class="col-lg-2">
                  <input class="btn btn-success" type="submit" value="Send">
                </div>
              </div>
            </form>


          </div>



          </body>

          <script type="text/javascript">

            const actualBtn = document.getElementById('file');

            const fileChosen = document.getElementById('file-chosen');

            actualBtn.addEventListener('change', function () {
              fileChosen.textContent = this.files[0].name
            })


            $(document).ready(function () {
              $(document).on('submit', '#post-form', function (e) {
                e.preventDefault();

                $.ajax({
                  type: 'POST',
                  url: '/lsp/send',
                  data: {
                    username: $('#username').val(),
                    friend: $('#friend').val(),
                    message: $('#message').val(),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                  },
                  success: function (data) {
                    //alert(data)
                  },
                  error: function (data) {
                    // there was an error.
                    //alert("An error occured!");
                  }
                });
                document.getElementById('message').value = '';
              });
            })

            $(document).ready(function () {
              $(document).on('submit', '#form', function (e) {
                e.preventDefault();
                var formData = new FormData($('#form')[0]);
                if (document.getElementById('file').files.length != 0) {
                  document.getElementById('file-chosen').textContent = "Sending...";
                  document.getElementById('upload-btn').disabled = true;
                  document.getElementById('upload-btn').classList.add('disabled');
                }
                $.ajax({
                  type: 'POST',
                  url: '/uploadfiles/{{friend}}',
                  processData: false,
                  contentType: false,
                  data: formData,
                  csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                  success: function (data) {
                    // The file was uploaded successfully... 
                    document.getElementById('file-chosen').textContent = "No file chosen";
                    document.getElementById('upload-btn').disabled = false;
                    document.getElementById('upload-btn').classList.remove('disabled');
                    //alert(data);
                  },
                  error: function (data) {
                    // there was an error.
                    document.getElementById('file-chosen').textContent = "No file chosen";
                    document.getElementById('upload-btn').disabled = false;
                    document.getElementById('upload-btn').classList.remove('disabled');
                    //alert("An error occured!");
                  }
                });
                document.getElementById('file').value = "";
                //document.getElementById('file-chosen').textContent = "No file chosen";
              });
            })
          </script>

        </div>
      </div>
    </div>
    </div>
  </section>
</main>
{% endblock %}